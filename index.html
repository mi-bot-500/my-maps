<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa GPX Personale</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; font-family: sans-serif; }
        #sidebar { 
            width: 300px; 
            height: 100vh; 
            overflow-y: auto; 
            background: #f8f9fa; 
            border-right: 1px solid #ccc;
            z-index: 1000;
        }
        #map { flex-grow: 1; height: 100vh; }
        .track-item { 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
            transition: background 0.2s;
        }
        .track-item:hover { background: #e9ecef; }
        .track-item b { display: block; color: #007bff; }
        .track-info { font-size: 12px; color: #666; }
        .leaflet-tooltip { font-size: 14px; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div style="padding: 15px; background: #007bff; color: white;">
            <h3 style="margin:0;">I miei percorsi</h3>
        </div>
        <div id="track-list">
            <p style="padding: 15px;">Caricamento tracce...</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
        // 1. Configurazione livelli
        var googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps'
        });
        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps'
        });

        var map = L.map('map', { center: [0, 0], zoom: 2, layers: [googleTerrain] });

        var baseMaps = { "Rilievo": googleTerrain, "Satellite": googleSat };
        L.control.layers(baseMaps).addTo(map);

        // 2. Configurazione GitHub
        const user = 'mi-bot-500';
        const repo = 'my-maps';
        const folder = 'tracks';
        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${folder}`;

        async function loadAllTracks() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Errore API');
                const files = await response.json();
                const gpxFiles = files.filter(f => f.name.toLowerCase().endsWith('.gpx'));
                
                document.getElementById('track-list').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞
                gpxFiles.forEach(file => renderTrack(file.path, file.name));
            } catch (error) {
                document.getElementById('track-list').innerHTML = '<p style="padding:15px; color:red;">Errore caricamento</p>';
            }
        }

        function renderTrack(url, fileName) {
            const trackLayer = new L.GPX(url, {
                async: true,
                marker_options: { startIconUrl: '', endIconUrl: '', shadowUrl: '' },
                polyline_options: { color: '#0000FF', weight: 4, opacity: 0.6 }
            }).on('loaded', function(e) {
                const gpx = e.target;
                const name = gpx.get_name() || fileName;
                const dist = (gpx.get_distance() / 1000).toFixed(2);
                const date = gpx.get_start_time() ? gpx.get_start_time().toLocaleDateString('it-IT') : "N/D";

                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
                const item = document.createElement('div');
                item.className = 'track-item';
                item.innerHTML = `<b>${name}</b><div class="track-info">üìè ${dist} km | üìÖ ${date}</div>`;
                
                // –ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –≤ —Å–ø–∏—Å–∫–µ - –∑—É–º –Ω–∞ —Ç—Ä–µ–∫
                item.onclick = () => {
                    map.fitBounds(gpx.getBounds(), { padding: [50, 50] });
                };
                
                document.getElementById('track-list').appendChild(item);

                // –¢—É–ª—Ç–∏–ø –Ω–∞ –∫–∞—Ä—Ç–µ
                const info = `<b>${name}</b><br>üìè ${dist} km<br>üìÖ ${date}`;
                gpx.getLayers().forEach(layer => {
                    layer.bindTooltip(info, { sticky: true });
                    layer.on('mouseover', () => layer.setStyle({ color: '#FF0000', weight: 6 }));
                    layer.on('mouseout', () => layer.setStyle({ color: '#0000FF', weight: 4 }));
                });
                
                map.fitBounds(gpx.getBounds());
            }).addTo(map);
        }

        loadAllTracks();
    </script>
</body>
</html>
