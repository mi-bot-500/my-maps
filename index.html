<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa GPX</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; font-family: sans-serif; overflow: hidden; height: 100vh; }
        
        #sidebar { 
            width: 300px; 
            height: 100%; 
            background: #fff; 
            border-right: 1px solid #ddd; 
            transition: margin-left 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            z-index: 1001; 
            flex-shrink: 0;
        }
        #sidebar.hidden { margin-left: -300px; }

        #toggle-btn { 
            position: absolute; 
            left: 310px; 
            top: 15px; 
            z-index: 1002; 
            width: 35px; 
            height: 35px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            cursor: pointer; 
            transition: left 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #sidebar.hidden + #toggle-btn { left: 15px; }

        #map { flex-grow: 1; height: 100%; position: relative; }
        #track-list { overflow-y: auto; flex-grow: 1; }

        .track-item { 
            display: flex; 
            align-items: center; 
            padding: 8px 12px; 
            border-bottom: 1px solid #eee; 
            gap: 8px; 
        }
        .track-clickable { 
            cursor: pointer; 
            flex-grow: 1; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            overflow: hidden; 
        }
        .track-name { 
            font-weight: 600; 
            font-size: 13px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .track-dist { font-size: 11px; color: #666; background: #eee; padding: 2px 6px; border-radius: 10px; flex-shrink: 0; }
        .btn-download { background: #28a745; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 16px; flex-shrink: 0; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div style="padding: 15px; background: #007bff; color: white;">
            <h3 style="margin:0; font-size: 16px;">üìç –¢—Ä–µ–∫–∏</h3>
        </div>
        <div id="track-list"></div>
    </div>

    <button id="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
        var map = L.map('map', { center: [0, 0], zoom: 2 });
        
        L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
        }).addTo(map);

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏/–ø–æ–∫–∞–∑–µ –ø–∞–Ω–µ–ª–∏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ CSS –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
            setTimeout(() => { map.invalidateSize(); }, 350);
        }

        function getRandomColor() {
            const colors = ['#FF5733', '#33FF57', '#3357FF', '#F333FF', '#FF33A8', '#000000', '#FF8333', '#8D33FF'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        const user = 'mi-bot-500';
        const repo = 'my-maps';
        const folder = 'tracks';
        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${folder}`;

        async function loadAllTracks() {
            try {
                const response = await fetch(apiUrl);
                const files = await response.json();
                const gpxFiles = files.filter(f => f.name.toLowerCase().endsWith('.gpx'));
                
                document.getElementById('track-list').innerHTML = '';
                gpxFiles.forEach(file => renderTrack(file.path, file.name));
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞:", e);
            }
        }

        function renderTrack(url, fileName) {
            const trackColor = getRandomColor();
            
            new L.GPX(url, {
                async: true,
                marker_options: { startIconUrl: '', endIconUrl: '', shadowUrl: '' },
                polyline_options: { color: trackColor, weight: 4, opacity: 0.7 }
            }).on('loaded', function(e) {
                const gpx = e.target;
                const dist = (gpx.get_distance() / 1000).toFixed(1);

                const item = document.createElement('div');
                item.className = 'track-item';
                // –ó–¥–µ—Å—åfileName ‚Äî –ø–æ–ª–Ω–æ–µ –∏–º—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
                item.innerHTML = `
                    <div class="track-clickable" onclick="focusTrack('${url}')">
                        <span class="track-name" title="${fileName}" style="color:${trackColor}">${fileName}</span>
                        <span class="track-dist">${dist}km</span>
                    </div>
                    <a href="${url}" download class="btn-download">‚Üì</a>
                `;
                
                window[url] = gpx; 
                document.getElementById('track-list').appendChild(item);
                
                gpx.getLayers().forEach(layer => {
                    layer.bindTooltip(`${fileName} (${dist} km)`);
                    layer.on('mouseover', () => layer.setStyle({ weight: 7, opacity: 1 }));
                    layer.on('mouseout', () => layer.setStyle({ weight: 4, opacity: 0.7 }));
                });
                
                map.fitBounds(gpx.getBounds(), {padding: [30,30]});
            }).addTo(map);
        }

        function focusTrack(url) {
            const gpx = window[url];
            if (gpx) map.fitBounds(gpx.getBounds(), { padding: [40, 40] });
        }

        loadAllTracks();
    </script>
</body>
</html>
