<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa GPX Personale</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; width: 100%; margin: 0; }
        body { margin: 0; padding: 0; }
        .leaflet-tooltip { font-size: 14px; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
        // 1. Configurazione livelli
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' });
        var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenTopoMap' });
        var esriTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri Terrain' });
        var googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps' });
        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps' });

        // 2. Inizializzazione mappa
        var map = L.map('map', {
            center: [0, 0],
            zoom: 2,
            layers: [googleTerrain]
        });

        // 3. Menu livelli
        var baseMaps = {
            "Google Rilievo": googleTerrain,
            "Google Satellite": googleSat,
            "Esri Rilievo": esriTerrain,
            "Mappa Topografica": topo,
            "Standard OSM": osm
        };
        L.control.layers(baseMaps).addTo(map);

        // --- –ù–û–í–ê–Ø –ß–ê–°–¢–¨: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ GitHub API ---
        const user = 'mi-bot-500';
        const repo = 'my-maps';
        const folder = 'tracks';
        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${folder}`;

        async function loadAllTracks() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Errore nel caricamento della lista file');
                
                const files = await response.json();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ .gpx —Ñ–∞–π–ª—ã
                const gpxFiles = files.filter(file => file.name.toLowerCase().endsWith('.gpx'));

                gpxFiles.forEach(file => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º file.path –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø—É—Ç–∏
                    renderTrack(file.path);
                });
            } catch (error) {
                console.error('Errore:', error);
                alert('Impossibile caricare i file dalla cartella tracks. Controlla la console.');
            }
        }

        function renderTrack(url) {
            new L.GPX(url, {
                async: true,
                marker_options: { startIconUrl: '', endIconUrl: '', shadowUrl: '' },
                polyline_options: { color: '#0000FF', weight: 4, opacity: 0.6 }
            }).on('loaded', function(e) {
                var gpx = e.target;
                var name = gpx.get_name() || url.split('/').pop();
                var dist = (gpx.get_distance() / 1000).toFixed(2);
                var date = gpx.get_start_time() ? gpx.get_start_time().toLocaleDateString('it-IT') : "---";

                var info = `<b>${name}</b><br>üìÖ Data: ${date}<br>üìè Dist: ${dist} km<br>üñ±Ô∏è <i>Tasto destro per scaricare</i>`;

                gpx.getLayers().forEach(function(layer) {
                    layer.on('mouseover', function(evt) {
                        layer.setStyle({ color: '#FF0000', weight: 6, opacity: 1 });
                        layer.bindTooltip(info, { sticky: true }).openTooltip();
                    });
                    layer.on('mouseout', function() {
                        layer.setStyle({ color: '#0000FF', weight: 4, opacity: 0.6 });
                    });
                    layer.on('contextmenu', function(evt) {
                        L.DomEvent.stopPropagation(evt);
                        if (confirm("Scaricare il file " + url.split('/').pop() + "?")) {
                            var link = document.createElement('a');
                            link.href = url;
                            link.download = url.split('/').pop();
                            link.click();
                        }
                    });
                });

                // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –≤—Å–µ —Ç—Ä–µ–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                map.fitBounds(gpx.getBounds());
            }).addTo(map);
        }

        // –ó–∞–ø—É—Å–∫
        loadAllTracks();
    </script>
</body>
</html>
